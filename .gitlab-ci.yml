# example adopted
# https://github.com/python-poetry/poetry/discussions/4205

stages:
  - tests
  - validate

.install-deps-template: &install-deps
  before_script:
    - ln -fs /usr/share/zoneinfo/UTC /etc/localtime
    - cp DOIRootCA2.crt /usr/local/share/ca-certificates/.
    - apt-get update
    - apt-get -y upgrade
    - >-
      apt-get -y --fix-missing --no-install-recommends install gdal-bin
      libgdal-dev software-properties-common curl unzip git-all make
      build-essential wget ffmpeg libsm6 libxext6
    - apt-get -y install ca-certificates
    - apt-get clean
    - update-ca-certificates
    - export SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt
    - export CURL_CA_BUNDLE="${SSL_CERT_FILE}";
    - export GIT_SSL_CAINFO="${SSL_CERT_FILE}";
    - export PIP_CERT="${SSL_CERT_FILE}";
    - export REQUESTS_CA_BUNDLE="${SSL_CERT_FILE}";
    - export NODE_EXTRA_CA_CERTS="${SSL_CERT_FILE}";
    - export NPM_CONFIG_CAFILE="${SSL_CERT_FILE}";
    - conda config --set ssl_verify /etc/ssl/certs/ca-certificates.crt
    - mamba update -n base mamba
    - mamba env update -n base --file environment.yml
    - mamba init bash
    - source ~/.bashrc
    - source activate base
    - which python
    - poetry config virtualenvs.create false
    - poetry install

.docker-template: &docker
  <<: *install-deps
  image: condaforge/miniforge3:latest
  stage: tests

#test jobs -----------------------
check-code:
  <<: *docker
  script: nox -s pre-commit

check-safety:
  <<: *docker
  script:
    - nox -s safety

coverage-check:
  <<: *docker
  script:
    - nox -s tests
    - nox -s coverage

# check-typing:
#   <<: *docker
#   script:
#     - nox -s mypy

check-tests:
  <<: *docker
  script:
    - nox -s tests
# check-typeguard:
#   <<: *docker
#   script:
#     - nox -s typeguard
# Validate Inventory:
#   stage: validate
#   image: ${INTERNAL_REGISTRY}software/software-management:latest
#   script:
#     - software-management review
#       --project "${CI_PROJECT_PATH}"
#       --ref "${CI_COMMIT_BRANCH}"
#       --type "provisional"
#       --token "${GIT_TOKEN_CUSTOM}"
#   tags:
#     - chs-shared
