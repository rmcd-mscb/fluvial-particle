======================
Output XDMF files
======================

To view the model output data in Paraview, read the XDMF files (.xmf extension) with Paraview's built-in "XDMF Reader." There are four files that describe model output defined on different spatial grids (but equivalent temporal grids): particles.xmf holds the time series of particle positions and fields interpolated from the grid nodes; cells1d.xmf holds the time series of quantities described at the 1D grid cell centers; cells2d.xmf and cells3d.xmf are the same with reference to the 2D and 3D grids. Each of the grids must be described in the .xmf files in terms of their topology, geometry, temporal organization, and dataset location. These files are generated automatically by *fluvial-particle* following the descriptions below.


A quick note: in what follows, the capitalized, italicized words refer to XDMF defined types. In particular, the use of *Attributes* in XDMF is different from the usage of "Attributes" in an HDF5 file.


The particles exist as points in a *Polyvertex* topology, with geometry described by the (x, y, z) positions of every particle at a given time step. Quantities interpolated from the grid fields, such as channel bed elevation and the velocity vector, are attached to the particles grid as *Attributes* at every defined time value. All of the particle data arrays are stored in 2D arrays with first dimension time and second dimension particles. These arrays are sliced into at each time index using the *HyperSlab* item type.


The cell-centered data are computed on 1D, 2D, and 3D grids (for a fully 3D simulation). These have (N_s), (N_s*N_n), (N_s*N_n*N_z) points, respectively, that define the extent of each cell in the structured curvilinear grids. The cell-centered datasets therefore have dimensions (N_s-1), (N_s-1,N_n-1), (N_s-1,N_n-1,N_z-1). An important note here is that in both the HDF5 and XDMF files, the arrays that define the grid points need to be ordered as (N_z, N_n, N_s) while the cell-centered data arrays need to be ordered as (N_s-1,N_n-1,N_z-1). I have not researched the details of why this is the case except that it is the same ordering of the grid and cell coordinates as returned from querying the VTK structured grid object that holds the field data.


A temporal collection grid is used to organize the time series in each of the cells .xmf files, in the same way that the particles .xmf file was organized. In the cell-centered cases, however, the grid is unchanging with time and is therefore defined once at the start of each file and then referenced at every time step.
The grids of the cells 2D and 3D .xmf files are defined similarly to each other by using the XDMF structured mesh topology types that implicitly define the ordering of and connections between cells with grid geometry from coordinates retrieved from the input VTK data files. While it also represents cell-centered data, the 1D .xmf file actually defines the grid with the *Polyvertex* topology type and node-centered *Attributes* for two reasons. First, a 1D structured mesh is not a pre-defined XDMF type. Second, loading the 1D data as point data in Paraview allows the use of filters that apply directly to points; for instance the *Point Line Interpolator* filter creates simple line charts from the field data defined at each point.


A note of caution: the *HyperSlab* item type doesn't always play nicely with Paraview, to which the numerous online forum posts on the subject can atest. It seems to work fine when used in the particles context on the *Polyvertex* topology type, and also on the cells 1D and 2D grid geometry definitions. Experience on this project indicates that it does not work well in the 2D and 3D cases when slicing into cell-centered *Attributes* inside of the temporal collection grid, i.e. when the HDF5 data are stored in one array that has an extra dimension for time. For this reason, the cell-centered data in the HDF5 file are written to a new dataset per time step so that the entire dataset can be loaded by Paraview at once.